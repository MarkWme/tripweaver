name: debug-oidc
on: { workflow_dispatch: {} }

permissions:
  id-token: write
  contents: read

jobs:
  debug-oidc:
    runs-on: ubuntu-latest
    steps:
      - name: Get OIDC token for JFrog
        id: oidc
        run: |
          set -euo pipefail
          AUD="${{ vars.JF_URL }}"
          AUD="${AUD%/}"
          URL="${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=${AUD}"
          TOKEN_JSON=$(curl -sS -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" "$URL")
          TOKEN=$(echo "$TOKEN_JSON" | jq -r '.value')
          echo "token=$TOKEN" >> "$GITHUB_OUTPUT"
          printf '%s\n' "$TOKEN_JSON" > gh-oidc-response.json

      - name: Show claims
        run: |
          echo "${{ steps.oidc.outputs.token }}" \
          | cut -d. -f2 | tr '_-' '/+' | base64 -d 2>/dev/null | jq .

      - name: Exchange ID token at JFrog
        id: jf-exchange
        env:
          IDTOKEN: ${{ steps.oidc.outputs.token }}
        run: |
          set -euo pipefail
          JF="${{ vars.JF_URL }}"
          JF="${JF%/}"
          EX_URL="$JF/access/api/v1/oidc/token"
          PAYLOAD=$(jq -nc \
            --arg gt  "urn:ietf:params:oauth:grant-type:token-exchange" \
            --arg stt "urn:ietf:params:oauth:token-type:id_token" \
            --arg tok "$IDTOKEN" \
            --arg pn  "${{ vars.JF_OIDC_PROVIDER }}" \
            '{grant_type:$gt,subject_token_type:$stt,subject_token:$tok,provider_name:$pn}')
          RESP=$(curl -sS -X POST -H "Content-Type: application/json" "$EX_URL" -d "$PAYLOAD")
          printf '%s\n' "$RESP" | jq . > jfrog-exchange-response.json || true
          if echo "$RESP" | jq -e .access_token >/dev/null 2>&1; then
            echo "access_token=$(echo "$RESP" | jq -r .access_token)" >> "$GITHUB_OUTPUT"
          else
            echo "JFrog exchange failed. See jfrog-exchange-response.json"
            exit 1
          fi

      - name: Download JFrog CLI and ping
        id: jf-cli
        env:
          AT: ${{ steps.jf-exchange.outputs.access_token }}
        run: |
          set -euo pipefail
          curl -fL https://releases.jfrog.io/artifactory/jfrog-cli/v2-jf/jfrog-cli-linux-amd64/jf -o jf
          chmod +x jf
          ./jf rt ping --url "${{ vars.JF_URL }}" --access-token "$AT" 2>&1 | tee jfrog-cli-ping.log
          grep -i 'Trace ID' jfrog-cli-ping.log || true

      - name: Upload OIDC/JFrog debug logs
        uses: actions/upload-artifact@v4
        with:
          name: jfrog-oidc-debug
          path: |
            gh-oidc-response.json
            jfrog-exchange-response.json
            jfrog-cli-ping.log
            ~/.jfrog/logs/**/*.log
