name: debug-oidc
on: { workflow_dispatch: {} }

permissions:
  id-token: write
  contents: read

jobs:
  debug-oidc:
    runs-on: ubuntu-latest
    env:
      # Define in GitHub → Settings → Variables
      # JF_URL e.g. https://solengeu.jfrog.io
      # JF_PROVIDER_NAME e.g. github-oidc
      JF_URL: ${{ vars.JF_URL }}
      JF_PROVIDER_NAME: ${{ vars.JF_OIDC_PROVIDER }}

    steps:
      - name: Fetch GitHub OIDC ID token
        id: gh-oidc
        run: |
          set -euo pipefail
          : "${ACTIONS_ID_TOKEN_REQUEST_URL:?missing}"
          : "${ACTIONS_ID_TOKEN_REQUEST_TOKEN:?missing}"
          : "${JF_URL:?missing}"

          AUD="${JF_URL%/}"
          URL="${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=${AUD}"

          RESP="$(curl -sS -H "Authorization: bearer ${ACTIONS_ID_TOKEN_REQUEST_TOKEN}" "${URL}")"
          echo "${RESP}" | jq -e .value >/dev/null
          echo "idtoken=$(echo "${RESP}" | jq -r .value)" >> "$GITHUB_OUTPUT"

      - name: Show ID token claims (bash+jq only)
        run: |
          set -euo pipefail
          TOK="${TOKEN:?missing}"
          PAYLOAD="$(printf '%s' "$TOK" | cut -d. -f2 | tr '_-' '/+')"
          # pad for base64
          rem=$(( ${#PAYLOAD} % 4 ))
          if [ "$rem" -eq 2 ]; then PAYLOAD="${PAYLOAD}=="; elif [ "$rem" -eq 3 ]; then PAYLOAD="${PAYLOAD}="; fi
          printf '%s' "$PAYLOAD" | base64 -d | jq .
        env:
          TOKEN: ${{ steps.gh-oidc.outputs.idtoken }}

      - name: Exchange ID token at JFrog
        id: jf-exchange
        run: |
          set -euo pipefail
          : "${JF_URL:?missing}"
          : "${JF_PROVIDER_NAME:?missing}"
          : "${IDTOKEN:?missing}"

          EX_URL="${JF_URL%/}/access/api/v1/oidc/token"
          PAYLOAD="$(jq -nc \
             --arg gt  "urn:ietf:params:oauth:grant-type:token-exchange" \
             --arg stt "urn:ietf:params:oauth:token-type:id_token" \
             --arg tok "${IDTOKEN}
