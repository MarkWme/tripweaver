name: debug-oidc
on: { workflow_dispatch: {} }

permissions:
  id-token: write
  contents: read

jobs:
  debug-oidc:
    runs-on: ubuntu-latest
    steps:
      - name: Get OIDC token for JFrog
        id: oidc
        run: |
          set -euo pipefail
          AUD="${{ vars.JF_URL }}"; AUD="${AUD%/}"
          URL="${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=${AUD}"
          TOKEN_JSON=$(curl -sS -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" "$URL")
          TOKEN=$(echo "$TOKEN_JSON" | jq -r '.value')
          echo "token=$TOKEN" >> "$GITHUB_OUTPUT"
          printf '%s\n' "$TOKEN_JSON" > gh-oidc-response.json

      - name: Show claims
        run: |
          echo "${{ steps.oidc.outputs.token }}" \
          | cut -d. -f2 | tr '_-' '/+' | base64 -d 2>/dev/null | jq .

      # —— Make exchange non-fatal and log everything ——
      - name: Exchange ID token at JFrog
        id: jf-exchange
        continue-on-error: true
        env:
          IDTOKEN: ${{ steps.oidc.outputs.token }}
        run: |
          set -euo pipefail
          mkdir -p debug
          JF="${{ vars.JF_URL }}"; JF="${JF%/}"
          EX_URL="$JF/access/api/v1/oidc/token"

          PAYLOAD=$(jq -nc \
            --arg gt  "urn:ietf:params:oauth:grant-type:token-exchange" \
            --arg stt "urn:ietf:params:oauth:token-type:id_token" \
            --arg tok "$IDTOKEN" \
            --arg pn  "${{ vars.JF_OIDC_PROVIDER }}" \
            '{grant_type:$gt,subject_token_type:$stt,subject_token:$tok,provider_name:$pn}')

          # Capture HTTP status and body separately
          CODE=$(curl -sS -w '%{http_code}' -o debug/jfrog-exchange-body.json \
                 -X POST -H "Content-Type: application/json" "$EX_URL" -d "$PAYLOAD")
          echo "http_code=$CODE" >> "$GITHUB_OUTPUT"
          echo "payload.json" > /dev/null
          printf '%s\n' "$PAYLOAD" > debug/jfrog-exchange-payload.json

          # Pretty print or raw body for logs
          jq . debug/jfrog-exchange-body.json || cat debug/jfrog-exchange-body.json

          # Set outputs and exit status
          if jq -e .access_token debug/jfrog-exchange-body.json >/dev/null 2>&1; then
            AT=$(jq -r .access_token debug/jfrog-exchange-body.json)
            echo "access_token=$AT" >> "$GITHUB_OUTPUT"
            echo "ok=true" >> "$GITHUB_OUTPUT"
            exit 0
          else
            echo "ok=false" >> "$GITHUB_OUTPUT"
            # keep step marked as failed, but job continues due to continue-on-error
            exit 1
          fi

      # Only ping if exchange succeeded
      - name: Setup JFrog CLI
        if: steps.jf-exchange.outcome == 'success' || steps.jf-exchange.outputs.ok == 'true'
        uses: jfrog/setup-jfrog-cli@v4
        env:
          JF_URL: ${{ vars.JF_URL }}
        with:
          oidc-provider-name: ${{ vars.JF_OIDC_PROVIDER }}
          oidc-audience: ${{ vars.JF_URL }}

      - name: Run JFrog CLI
        if: steps.jf-exchange.outcome == 'success' || steps.jf-exchange.outputs.ok == 'true'
        run: |
          jf rt ping

      # Always upload artifacts, even if exchange failed
      - name: Upload OIDC/JFrog debug logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jfrog-oidc-debug
          path: |
            gh-oidc-response.json
            debug/jfrog-exchange-body.json
            debug/jfrog-exchange-payload.json
            debug/jfrog-cli-ping.log
            ~/.jfrog/logs/**/*.log
